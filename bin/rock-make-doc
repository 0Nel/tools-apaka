#! /bin/sh

usage() {
    echo "usage: rock-make-doc target_dir"
    echo "you must run it from within the autoproj installation that you want"
    echo "to generate the documentation for"
    exit 1
}

is_absolute() {
    case $1 in
        /*) return 0 ;;
        *) return 1 ;;
    esac
}

autoproj_dir=$PWD
target_dir=$1

if ! test -d "$autoproj_dir/autoproj"; then
    echo "$autoproj_dir is not an autoproj installation"
    echo
    usage
fi

if test -z "$target_dir"; then
    echo "no target dir given"
    echo
    usage
fi

if ! is_absolute "$target_dir"; then
    echo "$target_dir must be an absolute path"
    exit 1
fi

if test -d "$target_dir"; then
    echo "$target_dir already exists"
    exit 1
fi

set -e

tempdir=$(mktemp -d)
echo "generating documentation in $tempdir"

echo "generating documentation from the autoproj packages"
cd $autoproj_dir
autoproj doc
mkdir -p $target_dir
mv install/doc $target_dir/api

cd $tempdir
git clone git://gitorious.com/rock/doc.git main
cd main
rake

echo "moving main documentation in $target_dir"
mv out/* $target_dir

cd $autoproj_dir
rock-directory "$target_dir/package_directory"

echo "deleting $tempdir"
rm -rf $tempdir

