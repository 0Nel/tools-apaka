#! /bin/bash
# This script allows to setup an OSC directory using a package from the ubuntu archive
# The resulting directory is created in the current working directory

package_name=$1
version=$2
revision=$3
if test -z "$package_name" || test -z "$version"; then
    echo "usage: osc_ubuntu_universe_package package_name version [revision]"
    echo "Sets up an OSC directory using a package from the ubuntu archive"
    echo "The resulting directory is created in the current working directory"
    echo "It is automatically added and committed at the end of the script"
    exit 1
fi
package_name_prefix=$(echo $package_name | sed 's/\(.\).*/\1/')

set -e

mkdir -p $package_name

if test -n "$revision"; then
    if wget --spider http://archive.ubuntu.com/ubuntu/pool/universe/$package_name_prefix/$package_name/${package_name}_$version.orig.tar.gz; then
        compress=gz
    else
        compress=bz2
    fi
    if wget --spider http://archive.ubuntu.com/ubuntu/pool/universe/$package_name_prefix/$package_name/${package_name}_$version-$revision.debian.tar.gz; then
        diffstyle=debian.tar.gz
    else
        diffstyle=diff.gz
    fi

cat > $package_name/_service <<EOF
<services>
<service name="download_url">
    <param name="host">archive.ubuntu.com</param>
    <param name="path">/ubuntu/pool/universe/$package_name_prefix/$package_name/${package_name}_$version-$revision.dsc</param>
</service>
<service name="download_url">
    <param name="host">archive.ubuntu.com</param>
    <param name="path">/ubuntu/pool/universe/$package_name_prefix/$package_name/${package_name}_$version.orig.tar.$compress</param>
</service>
<service name="download_url">
    <param name="host">archive.ubuntu.com</param>
    <param name="path">/ubuntu/pool/universe/$package_name_prefix/$package_name/${package_name}_$version-$revision.$diffstyle</param>
</service>
</services>
EOF
else
if wget --spider http://archive.ubuntu.com/ubuntu/pool/universe/$package_name_prefix/$package_name/${package_name}_$version.tar.gz; then
    compress=gz
else
    compress=bz2
fi
cat > $package_name/_service <<EOF
<services>
<service name="download_url">
    <param name="host">archive.ubuntu.com</param>
    <param name="path">/ubuntu/pool/universe/$package_name_prefix/$package_name/${package_name}_$version.dsc</param>
</service>
<service name="download_url">
    <param name="host">archive.ubuntu.com</param>
    <param name="path">/ubuntu/pool/universe/$package_name_prefix/$package_name/${package_name}_$version.tar.$compress</param>
</service>
</services>
EOF
fi

osc add $package_name
osc ci $package_name -m "register ubuntu Universe package $package_name"
